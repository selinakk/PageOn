<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
  <title th:text="'PageOn í† ë¡  ' + ${vo2.title} + ' ìƒì„¸ë³´ê¸°'"></title>
</head>
<body>
<main th:fragment="forum-view">
  <div class="position-relative padding-medium">
    <div class="container">
      <div class="section-title d-md-flex justify-content-between align-items-center mb-4">
        <h3 class="d-flex align-items-center">í† ë¡  ìƒì„¸ë³´ê¸°</h3>
      </div>
      <div class="d-flex flex-wrap justify-content-md-between justify-content-center border-bottom pb-5">
        <div class="col-md-3 col-4 mb-2">
          <img class="img-fluid shadow-sm" th:src="@{/img/{workImgName}(workImgName=${vo2.workImgName})}" th:alt="|${vo2.workTitle} ì‘í’ˆ ì´ë¯¸ì§€|"/>
        </div>
        <div class="col-md-8 col-12">
          <div class="d-flex justify-content-between mb-4 text-black-50">
            <div>
              <small th:text="'ì¡°íšŒìˆ˜ '+${vo2.hitcount} "></small>
              <small th:text="' ê²Œì‹œì¼ '+${vo2.wdate}"></small>
            </div>
            <div>

              <a href="#" data-bs-toggle="modal" data-bs-target="#reportModal">ì‹ ê³ ğŸš«</a>
<!--              <span th:if="${vo2.user_id == user_id}">ë¡œê·¸ì¸id-->
                  |&nbsp;<a th:href="@{/forum/update(num=${vo2.num})}">ìˆ˜ì •</a>
              | <a href="#" data-bs-toggle="modal" data-bs-target="#deleteModal">ì‚­ì œ</a>
<!--              </span>-->
            </div>

          </div>
          <a th:href="@{/bookshelf/list(userId=${vo2.user_id})}" class="d-inline-flex align-items-center">
                      <span class="user-profile col-2 d-inline-flex me-2 border border-dark align-middle align-content-center justify-content-center">
                        <img class="w-100 h-100" th:src="@{/img/{userImgName}(userImgName=${vo2.userImgName})}" th:alt="|${vo2.userName}ë‹˜ í”„ë¡œí•„ ì´ë¯¸ì§€|">
                      </span>
            <strong th:text="${vo2.userName}"></strong>
          </a>
          <span class="align-super" th:text="'ë‹˜ì´ ê²Œì‹œí•œ '+${vo2.workTitle} + 'ì— ëŒ€í•œ í† ë¡ '"></span>
          <h6 class="mt-2 mb-3 py-2 fw-bold fs-3" th:text="'Q. '+${vo2.title}"></h6>
          <textarea th:text="${vo2.content}" rows="12" readonly disabled class="forum__textarea w-100 border-0"></textarea>
        </div>
      </div>
      <!-- ì—¬ê¸°ê°€ ëŒ“ê¸€ ê´€ë ¨ ë‚´ìš©ì…ë‹ˆë‹¤. ì´ë¶€ë¶„ì„ ë¶€ëª¨ê¸€ì˜ ìƒì„¸ë³´ê¸°ì™€ ì¶”ê°€í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤. -->
      <section id="comment" class="position-relative my-5">
        <h3>ëŒ“ê¸€<small th:text="'('+${vo2.commentCnt}+')'"></small></h3>
        <div class="replyForm">
          <textarea id="commentText" rows="4" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... 500ì ì´ë‚´"></textarea>
          <img src="/img/comment_write.png" alt="ëŒ€ëŒ“ê¸€ ì‘ì„±" onclick="submitComment()" class="comment-icon"/>
        </div>

        <div id="commentList">
          <div th:each="comment : ${comments}" class="comment" th:id="'comment-' + ${comment.num}">
            <p>
              <strong th:text="${comment.user_id}"></strong>:
              <span th:text="${comment.content}" class="comment-content"></span>
            </p>
            <p>ì‘ì„±ì¼: <span th:text="${comment.wdate}"></span></p>
            <div class="actionButtons">
              <img src="/img/comment_child.png" alt="ëŒ€ëŒ“ê¸€ ë”ë³´ê¸°" th:onclick="'fetchChildComments(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_childup.png" alt="ëŒ€ëŒ“ê¸€ ì¤„ì´ê¸°" th:onclick="'hideComment(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_write.png" alt="ëŒ€ëŒ“ê¸€ ì‘ì„±" th:onclick="'showReplyForm(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_update.png" alt="ìˆ˜ì •" th:onclick="'editComment(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_delete.png" alt="ì‚­ì œ" th:onclick="'deleteComment(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_report.png" alt="ì‹ ê³ " th:onclick="'reportComment(' + ${comment.num} + ')'" class="comment-icon"/>
            </div>

            <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ -->
            <div class="replyForm" th:id="'replyForm-' + ${comment.num}" style="display:none;">
              <textarea th:id="'replyText-' + ${comment.num}" rows="2" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
              <img src="/img/comment_write.png" alt="ì‘ì„±" th:onclick="'submitReply(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_delete.png" alt="ì·¨ì†Œ" th:onclick="'cancelReply(' + ${comment.num} + ')'" class="comment-icon"/>
            </div>

            <div class="editForm" th:id="'editForm-' + ${comment.num}" style="display:none;">
              <textarea th:id="'editText-' + ${comment.num}" rows="2" th:text="${comment.content}"></textarea>
              <img src="/img/comment_update.png" alt="ìˆ˜ì •" th:onclick="'submitEdit(' + ${comment.num} + ')'" class="comment-icon"/>
              <img src="/img/comment_delete.png" alt="ì·¨ì†Œ" th:onclick="'cancelEdit(' + ${comment.num} + ')'" class="comment-icon"/>
            </div>

            <div class="childComments" th:id="'childComments-' + ${comment.num}">
              <!-- ëŒ€ëŒ“ê¸€ì„ ê°€ì ¸ì˜¬ ê³µê°„ -->
            </div>

            <div th:id="'paging-' + ${comment.num}" style="display:none;">
              <!-- í˜ì´ì§•ì„ ìœ„í•œ div ì¶”ê°€ -->
            </div>
          </div>
        </div>

        <div id="paging">
          <ul>
            <li th:if="${cpage > 1}">
              <a th:href="@{/test(cpage=${cpage - 1}, pageBlock=${pageBlock})}">ì´ì „</a>
            </li>
            <li th:each="i : ${#numbers.sequence(1, totalPageCount)}" th:classappend="${i == cpage} ? 'active'">
              <a th:href="@{/test(cpage=${i}, pageBlock=${pageBlock})}" th:text="${i}"></a>
            </li>
            <li th:if="${cpage < totalPageCount}">
              <a th:href="@{/test(cpage=${cpage + 1}, pageBlock=${pageBlock})}">ë‹¤ìŒ</a>
            </li>
          </ul>
        </div>
        <script type="text/javascript">
          var fnum = [[${vo2.num}]]; // vo2.num ê°’ì„ ì •ìˆ˜ë¡œ ì €ì¥
          console.log("fnum:", fnum);

          function fetchChildComments(commentId, page = 1) {
            const childCommentsDiv = $('#childComments-' + commentId);
            const pagingDiv = $('#paging-' + commentId);

            // AJAX ìš”ì²­
            $.ajax({
              type: "GET",
              url: "/comments/child/" + commentId + "?cpage=" + page,
              success: function(response) {
                const childComments = response.childComments;
                const totalPageCount = response.totalPageCount;

                // ëŒ€ëŒ“ê¸€ì„ ì¶”ê°€
                childCommentsDiv.empty();
                if (childComments.length > 0) {
                  childComments.forEach(function(childComment) {
                    const childCommentElem = `
                    <div class="childComment" id="childComment-${childComment.num}">
                        <p><strong>${childComment.user_id}:</strong> ${childComment.content}</p>
                        <p>ì‘ì„±ì¼: ${childComment.wdate}</p>
                        <p>
                            <img src="/img/comment_child.png" alt="ëŒ€ëŒ“ê¸€ ë”ë³´ê¸°" onclick="fetchChildComments(${childComment.num})" class="comment-icon"/>
                            <img src="/img/comment_childup.png" alt="ëŒ€ëŒ“ê¸€ ì¤„ì´ê¸°" onclick="hideComment(${childComment.num})" class="comment-icon"/>
                            <img src="/img/comment_write.png" alt="ëŒ€ëŒ“ê¸€ ì‘ì„±" onclick="showReplyForm(${childComment.num}, true)" class="comment-icon"/>
                            <img src="/img/comment_update.png" alt="ìˆ˜ì •" onclick="editComment(${childComment.num}, true)" class="comment-icon"/>
                            <img src="/img/comment_delete.png" alt="ì‚­ì œ" onclick="deleteComment(${childComment.num}, true)" class="comment-icon"/>
                            <img src="/img/comment_report.png" alt="ì‹ ê³ " onclick="reportComment(${childComment.num}, true)" class="comment-icon"/>
                        </p>

                        <div class="replyForm" id="childReplyForm-${childComment.num}" style="display:none;">
                            <textarea id="replyText-${childComment.num}" rows="2" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <img src="/img/comment_write.png" alt="ì‘ì„±" onclick="submitReply(${childComment.num}, true)" class="comment-icon"/>
                            <img src="/img/comment_delete.png" alt="ì·¨ì†Œ" onclick="cancelReply(${childComment.num}, true)" class="comment-icon"/>
                        </div>

                        <div class="editForm" id="childEditForm-${childComment.num}" style="display:none;">
                            <textarea id="editText-${childComment.num}" rows="2" text="${childComment.content}"></textarea>
                            <img src="/img/comment_update.png" alt="ìˆ˜ì •" onclick="submitEdit(${childComment.num}, true)" class="comment-icon"/>
                            <img src="/img/comment_delete.png" alt="ì·¨ì†Œ" onclick="cancelEdit(${childComment.num}, true)" class="comment-icon"/>
                        </div>

                        <div class="childComments" id="childComments-${childComment.num}">
                            <!-- ëŒ€ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ì„ ê°€ì ¸ì˜¬ ê³µê°„ -->
                        </div>

                        <div id="paging-${childComment.num}" style="display:none;">
                            <!-- í˜ì´ì§•ì„ ìœ„í•œ div ì¶”ê°€ -->
                        </div>
                    </div>
                    `;
                    childCommentsDiv.append(childCommentElem);
                  });
                }

                // í˜ì´ì§• ì •ë³´ ì¶”ê°€
                updatePaging(pagingDiv, totalPageCount, page, commentId);
                childCommentsDiv.show();
                pagingDiv.show();
              },
              error: function() {
                alert("ëŒ€ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }

          // í˜ì´ì§• ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
          function updatePaging(pagingDiv, totalPageCount, currentPage, commentId) {
            pagingDiv.empty(); // ê¸°ì¡´ í˜ì´ì§• ë‚´ìš©ì„ ì§€ìš°ê¸°

            // í˜ì´ì§€ ìˆ˜ê°€ 1 ì´í•˜ì¼ ê²½ìš° í˜ì´ì§• divë¥¼ ìˆ¨ê¹€
            if (totalPageCount <= 1) {
              pagingDiv.hide();
              return;
            }

            // í˜ì´ì§€ ë§í¬ ìƒì„±
            for (let i = 1; i <= totalPageCount; i++) {
              const pageLink = $(`<span class="page-link" onclick="fetchChildComments(${commentId}, ${i})">${i}</span>`);
              if (i === currentPage) {
                pageLink.addClass('active'); // í˜„ì¬ í˜ì´ì§€ ê°•ì¡°
              }
              pagingDiv.append(pageLink);
            }

            // í˜ì´ì§• divë¥¼ ë³´ì—¬ì¤Œ
            pagingDiv.show();
          }

          function hideComment(commentId) {
            const childCommentsDiv = $('#childComments-' + commentId); // ëŒ€ëŒ“ê¸€ div
            const toggleButton = childCommentsDiv.siblings('img[alt="ëŒ€ëŒ“ê¸€ ì¤„ì´ê¸°"]'); // ì¤„ì´ê¸° ë²„íŠ¼
            const showMoreButton = childCommentsDiv.siblings('img[alt="ëŒ€ëŒ“ê¸€ ë”ë³´ê¸°"]'); // ë”ë³´ê¸° ë²„íŠ¼
            const pagingDiv = $('#paging-' + commentId); // í˜ì´ì§• div

            // ëŒ€ëŒ“ê¸€ ëª©ë¡ ìˆ¨ê¸°ê¸°
            childCommentsDiv.hide(); // ëŒ€ëŒ“ê¸€ ëª©ë¡ ìˆ¨ê¸°ê¸°
            toggleButton.hide(); // ì¤„ì´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            showMoreButton.show(); // ë”ë³´ê¸° ë²„íŠ¼ ë³´ì´ê¸°
            pagingDiv.hide(); // í˜ì´ì§• ìˆ¨ê¸°ê¸°
          }

          function submitComment() {
            const commentText = $('#commentText').val().trim();
            if (!commentText) {
              alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }

            $.ajax({
              type: "POST",
              url: "/comments",
              contentType: "application/json",
              data: JSON.stringify({
                content: commentText,
                type: "forum", // ë¶€ëª¨ê¸€ íƒ€ì…
                fnum: fnum, // ë¶€ëª¨ê¸€id
                user_id: "tester2" // ë¡œê·¸ì¸id
              }),
              success: function() {
                location.reload();
              },
              error: function() {
                alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }

          function submitReply(parentId) {
            const replyText = $(`#replyText-${parentId}`).val().trim();
            if (!replyText) {
              alert("ëŒ€ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }

            $.ajax({
              type: "POST",
              url: "/comments",
              contentType: "application/json",
              data: JSON.stringify({
                content: replyText,
                type: "forum", // ë¶€ëª¨ê¸€ íƒ€ì…
                fnum: fnum, // ë¶€ëª¨ê¸€id
                cnum: parentId,
                user_id: "tester2" // ë¡œê·¸ì¸id
              }),
              success: function() {
                location.reload();
              },
              error: function() {
                alert("ëŒ€ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }

          function showReplyForm(commentId, isChild = false) {
            // ëŒ€ëŒ“ê¸€ì˜ IDì— ë§ì¶° í¼ IDë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
            const formId = isChild ? 'childReplyForm-' + commentId : 'replyForm-' + commentId;
            document.getElementById(formId).style.display = 'block'; // í•´ë‹¹ í¼ì„ ë³´ì´ê²Œ í•¨
          }

          function cancelReply(commentId, isChild = false) {
            const formId = isChild ? 'childReplyForm-' + commentId : 'replyForm-' + commentId;
            document.getElementById(formId).style.display = 'none'; // í•´ë‹¹ í¼ ìˆ¨ê¸°ê¸°
          }

          function editComment(commentId, isChild = false) {
            // ëŒ€ëŒ“ê¸€ì˜ IDì— ë§ì¶° ìˆ˜ì • í¼ ID ì„¤ì •
            const editFormId = isChild ? `#childEditForm-${commentId}` : `#editForm-${commentId}`;
            const commentElemId = isChild ? `#childComment-${commentId}` : `#comment-${commentId}`;

            // ëŒ€ëŒ“ê¸€ ë˜ëŠ” ì¼ë°˜ ëŒ“ê¸€ì—ì„œ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì˜´
            const commentContentElem = $(commentElemId).find('p').first();

            // ì‘ì„±ìì˜ ì´ë¦„ê³¼ ë‚´ìš©ì„ ë¶„ë¦¬í•˜ì—¬ ë‚´ìš©ë§Œ ê°€ì ¸ì˜´
            const fullCommentText = commentContentElem.length > 0 ? commentContentElem.text().trim() : '';

            // ì‘ì„±ì ì´ë¦„ê³¼ ë‚´ìš© ë¶„ë¦¬ (ì‘ì„±ì: ë‚´ìš© í˜•íƒœ)
            const contentStartIndex = fullCommentText.indexOf(':') + 2; // ': ' ë‹¤ìŒ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘
            const commentText = fullCommentText.substring(contentStartIndex).trim(); // ë‚´ìš©ë§Œ ì¶”ì¶œ

            // ê¸°ì¡´ ë‚´ìš©ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ë¥¼ ì—…ë°ì´íŠ¸
            $(editFormId).find('textarea').val(commentText);
            $(editFormId).show(); // ìˆ˜ì • í¼ì„ ë³´ì´ê²Œ í•¨
          }

          function submitEdit(commentId) {
            const newCommentText = $(`#editText-${commentId}`).val().trim();

            $.ajax({
              type: "PUT",
              url: "/comments/" + commentId,
              contentType: "application/json",
              data: JSON.stringify({
                content: newCommentText,
                user_id: "tester2" // ë¡œê·¸ì¸id
              }),
              success: function() {
                location.reload();
              },
              error: function() {
                alert("ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }

          function cancelEdit(commentId, isChild = false) {
            const editFormId = isChild ? '#childEditForm-' + commentId : '#editForm-' + commentId;
            $(editFormId).hide(); // í•´ë‹¹ ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸°
          }

          function deleteComment(commentId, isChild = false) {
            if (confirm("ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              $.ajax({
                type: "DELETE",
                url: "/comments/" + commentId,
                success: function() {
                  const commentSelector = isChild ? `#childComment-${commentId}` : `#comment-${commentId}`;
                  $(commentSelector).remove();
                },
                error: function() {
                  alert("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              });
            }
          }

          function reportComment(commentId) {
            // ì‹ ê³  ìš”ì²­ì„ ë³´ë‚´ëŠ” AJAX í˜¸ì¶œ
            $.ajax({
              type: "PUT",
              url: "/comments/report/" + commentId, // ì‹ ê³ ë¥¼ ì²˜ë¦¬í•  ê²½ë¡œ
              success: function() {
                alert("ëŒ“ê¸€ì´ ì‹ ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.");
              },
              error: function() {
                alert("ëŒ“ê¸€ ì‹ ê³ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }
        </script>
      </section>
      <div class="d-flex justify-content-center py-3">
        <a href="/forum/list" class="btn btn-dark">ëª©ë¡ìœ¼ë¡œ</a>
      </div>
    </div>
  </div>
  <div class="modal modal-md fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-center" th:text="${vo2.title}+' í† ë¡ ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'"></p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn btn-dark">ë‹«ê¸°</button>
        <a th:href="@{/forum/deleteOK(num=${vo2.num})}" class="btn btn-danger">ì‚­ì œ</a>
      </div>
    </div>
  </div>
  </div>
  <div class="modal modal-md fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>ê²Œì‹œê¸€ì— ìš•ì„¤, ë¹„ë°©, ë¹„í•˜ ë“± ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ëœ ê²½ìš°<br/>ì‹ ê³  ë°”ëë‹ˆë‹¤.</p>
        <p>ê´€ë¦¬ìê°€ í™•ì¸ í›„ ê²Œì‹œê¸€ ì‚­ì œ ì²˜ë¦¬í•  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn btn-dark">ë‹«ê¸°</button>
        <a th:href="@{/forum/report(num=${vo2.num})}" class="btn btn-danger">ì‹ ê³ </a>
      </div>
    </div>
  </div>
  </div>
</main>
</body>
</html>
